import 'dart:async';

import 'package:flutter/material.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:intl/intl.dart';
import 'package:ogrenci_takip_sistemi/api.dart/daily_tracking_api.dart';
import 'package:ogrenci_takip_sistemi/pdf_report_button.dart';
import '../../image_cache_manager.dart';
import '../../scrollable_table_widget.dart';
import 'package:ogrenci_takip_sistemi/models/daily_tracking_model.dart';
import 'package:ogrenci_takip_sistemi/models/student_model.dart';
import 'package:ogrenci_takip_sistemi/models/classes_model.dart';
import 'package:ogrenci_takip_sistemi/blocs/daily_tracking/daily_tracking_bloc.dart';
import 'package:ogrenci_takip_sistemi/blocs/daily_tracking/daily_tracking_event.dart';
import 'package:ogrenci_takip_sistemi/blocs/daily_tracking/daily_tracking_state.dart';
import 'package:ogrenci_takip_sistemi/blocs/daily_tracking/daily_tracking_repository.dart';

// ClassInfo sƒ±nƒ±fƒ± - PDF raporu i√ßin
class ClassInfo {
  final int id;
  final String name;

  ClassInfo({required this.id, required this.name});
}

// Ana sƒ±nƒ±f - ≈üimdi BLoC kullanƒ±yor
class DailyTrackingScreen extends StatelessWidget {
  const DailyTrackingScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (context) => DailyTrackingBloc(
        repository: DailyTrackingRepository(baseUrl: 'http://localhost:3000'),
      )..add(LoadClasses()),
      child: const DailyTrackingView(),
    );
  }
}

class DailyTrackingView extends StatefulWidget {
  const DailyTrackingView({super.key});

  @override
  _DailyTrackingViewState createState() => _DailyTrackingViewState();
}

class _DailyTrackingViewState extends State<DailyTrackingView> {
  // Renk sabitleri
  final Color weekdayHeaderColor = Colors.blue.shade100;
  final Color weekendHeaderColor = Colors.amber.shade100;
  final Color weekdayBgColor = Colors.white;
  final Color weekendBgColor = Colors.grey.shade200;
  final Color dataEntryWeekdayColor = Colors.yellow.shade100;
  final Color dataEntryWeekendColor = Colors.orange.shade100;
  final Color weeklyTotalColor = Colors.green.shade200;
  final Color monthlyTotalColor = Colors.purple.shade300;

  // Add these constants
  final double studentColWidth = 200.0;
  final double courseColWidth = 120.0;
  final double dayColWidth = 40.0;
  final double totalColWidth = 60.0;
  final double weeklyTotalWidth = 70.0;

  // Scroll controller
  final ScrollController _horizontalScrollController = ScrollController();

  // Debounce timers for text input
  final Map<String, Timer> _debounceTimers = {};

  // Performance optimization: Cache frequently used calculations
  final Map<String, int> _calculationCache = {};
  
  // Track which cell is currently being edited to show TextField only for that cell
  String? _editingCellKey;

  @override
  void dispose() {
    _horizontalScrollController.dispose();
    // Cancel all debounce timers
    for (final timer in _debounceTimers.values) {
      timer.cancel();
    }
    _calculationCache.clear();
    super.dispose();
  }

  // Performance optimization: Clear cache when state changes significantly
  void _clearCalculationCache() {
    _calculationCache.clear();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('G√ºnl√ºk Takip'),
        backgroundColor: Colors.blue,
        actions: [
          BlocBuilder<DailyTrackingBloc, DailyTrackingState>(
            // Performance optimization: Only rebuild when necessary
            buildWhen: (previous, current) {
              return current is TrackingDataLoaded && 
                     (previous is! TrackingDataLoaded || 
                      previous.currentClassId != current.currentClassId ||
                      previous.students.length != current.students.length);
            },
            builder: (context, state) {
              if (state is TrackingDataLoaded && 
                  state.currentClassId != null && 
                  state.students.isNotEmpty) {
                final classInfo = state.classes
                    .firstWhere((c) => c.id == state.currentClassId!);
                return PDFReportButton(
                  classInfo: ClassInfo(
                    id: state.currentClassId!,
                    name: classInfo.sinifAdi,
                  ),
                  students: state.students,
                  trackingData: state.trackingData,
                  weeklyData: state.weeklyData,
                  reportDate: state.selectedMonth,
                );
              }
              return const SizedBox.shrink();
            },
          ),
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: () {
              // Clear cache on refresh
              _clearCalculationCache();
              context.read<DailyTrackingBloc>().add(RefreshData());
            },
            tooltip: 'Verileri Yenile',
          ),
          // Performance monitoring indicator
          if (kDebugMode)
            IconButton(
              icon: Icon(
                Icons.memory,
                color: _calculationCache.length > 100 ? Colors.orange : Colors.green,
              ),
              onPressed: () {
                print('üéØ Performance Stats:');
                print('üìä Cache entries: ${_calculationCache.length}');
                print('‚è±Ô∏è Active timers: ${_debounceTimers.length}');
                print('üé≠ Editing cell: ${_editingCellKey ?? "None"}');
              },
              tooltip: 'Performance Info (${_calculationCache.length} cached)',
            ),
        ],
      ),
      body: BlocListener<DailyTrackingBloc, DailyTrackingState>(
        listener: (context, state) {
          if (state is DailyTrackingError) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(state.message),
                backgroundColor: Colors.red,
              ),
            );
          } else if (state is DailyTrackingOperationSuccess) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(state.message),
                duration: const Duration(seconds: 1),
              ),
            );
          }
          // Clear cache when state changes
          _clearCalculationCache();
        },
        child: BlocBuilder<DailyTrackingBloc, DailyTrackingState>(
          // Performance optimization: Reduce unnecessary rebuilds
          buildWhen: (previous, current) {
            if (current is DailyTrackingLoading ||
                current is DailyTrackingError ||
                current is TrackingDataLoaded ||
                current is ClassesLoaded) {
              return true;
            }
            return false;
          },
          builder: (context, state) {
            if (state is DailyTrackingLoading) {
              return const Center(child: CircularProgressIndicator());
            } else if (state is DailyTrackingError) {
              return Center(child: Text(state.message));
            } else if (state is TrackingDataLoaded) {
              return _buildTrackingContent(state);
            } else if (state is ClassesLoaded) {
              // Classes loaded but no class selected yet
              return _buildTrackingContent(TrackingDataLoaded(
                classes: state.classes,
                currentClassId: state.classes.isNotEmpty ? state.classes.first.id : null,
                students: const [],
                trackingData: const {},
                weeklyData: const {},
                selectedMonth: DateTime.now(),
                expandedStudents: const {},
              ));
            }
            return const Center(child: Text('Ba≈ülatƒ±lƒ±yor...'));
          },
        ),
      ),
    );
  }

  Widget _buildTrackingContent(TrackingDataLoaded state) {
    return Column(
      children: [
        _buildHeaderControls(state),
        const Divider(),
        Expanded(
          child: _buildTrackingTable(state),
        ),
      ],
    );
  }

  Widget _buildHeaderControls(TrackingDataLoaded state) {
    return Padding(
      padding: const EdgeInsets.all(8.0),
      child: Row(
        children: [
          // Sƒ±nƒ±f se√ßim dropdown
          Expanded(
            flex: 3,
            child: state.classes.isEmpty
                ? const Text('Hen√ºz sƒ±nƒ±f bulunmamaktadƒ±r.')
                : DropdownButtonFormField<int>(
                    decoration: const InputDecoration(
                      labelText: 'Sƒ±nƒ±f Se√ßin',
                      border: OutlineInputBorder(),
                    ),
                    value: state.currentClassId,
                    items: state.classes.map((classItem) {
                      return DropdownMenuItem<int>(
                        value: classItem.id,
                        child: Text(classItem.sinifAdi),
                      );
                    }).toList(),
                    onChanged: (value) {
                      if (value != null) {
                        context.read<DailyTrackingBloc>().add(SelectClass(value));
                      }
                    },
                  ),
          ),
          const SizedBox(width: 16),
          // Ay navigasyonu
          IconButton(
            icon: const Icon(Icons.chevron_left),
            onPressed: () => context.read<DailyTrackingBloc>().add(const ChangeMonth(-1)),
          ),
          Text(
            DateFormat('MMMM yyyy', 'tr_TR').format(state.selectedMonth),
            style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          IconButton(
            icon: const Icon(Icons.chevron_right),
            onPressed: () => context.read<DailyTrackingBloc>().add(const ChangeMonth(1)),
          ),
        ],
      ),
    );
  }

  Widget _buildTrackingTable(TrackingDataLoaded state) {
    if (state.students.isEmpty) {
      return const Center(child: Text('Bu sƒ±nƒ±fta √∂ƒürenci bulunmamaktadƒ±r.'));
    }

    final daysInMonth = _getDaysInMonth(state.selectedMonth);

    // Calculate table width
    double tableWidth = studentColWidth + courseColWidth + totalColWidth;
    for (int i = 0; i < daysInMonth.length; i++) {
      tableWidth += dayColWidth;
      if (daysInMonth[i].weekday == DateTime.sunday ||
          i == daysInMonth.length - 1) {
        tableWidth += weeklyTotalWidth;
      }
    }

    // Create header row
    final headerRow = Row(
      children: [
        // Student header
        Container(
          width: studentColWidth,
          padding: const EdgeInsets.all(8),
          color: Colors.blue.shade100,
          alignment: Alignment.centerLeft,
          child: const Text(
            '√ñƒürenci',
            style: TextStyle(fontWeight: FontWeight.bold),
          ),
        ),

        // Course header
        Container(
          width: courseColWidth,
          padding: const EdgeInsets.all(8),
          color: Colors.blue.shade100,
          alignment: Alignment.center,
          child: const Text(
            'Ders',
            style: TextStyle(fontWeight: FontWeight.bold),
          ),
        ),

        // Day headers and weekly totals
        ..._buildHeaderCells(daysInMonth).map((cell) => Container(
              color: Colors.blue.shade100,
              child: cell,
            )),

        // Monthly total header
        Container(
          width: 100,
          padding: const EdgeInsets.all(8),
          color: const Color.fromARGB(255, 238, 102, 243),
          alignment: Alignment.center,
          child: const Text(
            'TOPLAM',
            style: TextStyle(fontWeight: FontWeight.bold, color: Colors.white),
          ),
        ),
      ],
    );

    // Use the ScrollableTable widget
    return ScrollableTable(
      header: headerRow,
      contentWidth: tableWidth + 50,
      itemCount: state.students.length,
      itemBuilder: (context, index) {
        return _buildStudentSection(state.students[index], state, daysInMonth);
      },
    );
  }

  // G√ºn adƒ± kƒ±saltmasƒ±nƒ± getiren yardƒ±mcƒ± fonksiyon
  String _getDayAbbreviation(int weekday) {
    const Map<int, String> abbrevs = {
      1: "Pt", 2: "Sa", 3: "√áa", 4: "Pe", 5: "Cu", 6: "Ct", 7: "Pa",
    };
    return abbrevs[weekday] ?? "?";
  }

  // Aydaki g√ºnleri getir
  List<DateTime> _getDaysInMonth(DateTime month) {
    final firstDay = DateTime(month.year, month.month, 1);
    final lastDay = DateTime(month.year, month.month + 1, 0);
    return List.generate(
      lastDay.day,
      (index) => DateTime(month.year, month.month, index + 1),
    );
  }

  // Header cells building with correct week calculation
  List<Widget> _buildHeaderCells(List<DateTime> daysInMonth) {
    List<Widget> cells = [];

    // Hafta tanƒ±mlayƒ±cƒ±larƒ±nƒ± takip et
    Set<String> addedWeeks = {};

    // Yƒ±l-hafta formatƒ±nda benzersiz tanƒ±mlayƒ±cƒ±
    String weekIdentifier(DateTime date) =>
        '${date.year}-${_getWeekOfYear(date)}';

    for (int i = 0; i < daysInMonth.length; i++) {
      final day = daysInMonth[i];
      final isWeekend = _isWeekend(day);

      // T√ºrk√ße g√ºn kƒ±saltmasƒ± (Pt, Sa, √áa, vb.)
      final String dayAbbr = _getDayAbbreviation(day.weekday);

      // Normal g√ºn h√ºcresi - g√ºn√º ve g√ºn adƒ±nƒ±n kƒ±saltmasƒ±nƒ± g√∂ster
      cells.add(Container(
        width: dayColWidth,
        padding: const EdgeInsets.symmetric(horizontal: 2, vertical: 2),
        decoration: BoxDecoration(
          color: isWeekend ? weekendHeaderColor : weekdayHeaderColor,
          border: Border.all(color: Colors.grey.shade300, width: 0.5),
        ),
        alignment: Alignment.center,
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(
              day.day.toString(),
              textAlign: TextAlign.center,
              style: TextStyle(
                fontWeight: FontWeight.bold,
                fontSize: 12,
                color: isWeekend ? Colors.brown.shade800 : Colors.blue.shade800,
              ),
            ),
            Text(
              dayAbbr,
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 9,
                color: isWeekend ? Colors.brown.shade800 : Colors.blue.shade800,
              ),
            ),
          ],
        ),
      ));

      // Hafta toplamƒ± kontrol√º
      bool needsWeekTotal = false;
      String weekId = weekIdentifier(day);

      // Son g√ºne geldik mi?
      bool isLastDay = i == daysInMonth.length - 1;

      // Pazar g√ºn√º m√º?
      bool isWeekEnd = day.weekday == DateTime.sunday;

      // Yarƒ±n farklƒ± bir haftaya mƒ± ge√ßiyor?
      bool isNewWeekTomorrow = false;
      if (!isLastDay) {
        isNewWeekTomorrow = !_isSameWeek(day, daysInMonth[i + 1]);
      }

      // Hafta toplamƒ±nƒ± g√∂sterme kararƒ±
      if ((isWeekEnd ||
              (isLastDay && day.weekday == DateTime.sunday) ||
              isNewWeekTomorrow) &&
          !addedWeeks.contains(weekId)) {
        needsWeekTotal = true;
        addedWeeks.add(weekId);
      }

      // Ayƒ±n sonundayƒ±z ve hafta tamamlanmamƒ±≈ü - hafta toplamƒ± g√∂sterme
      if (isLastDay && !isWeekEnd && !addedWeeks.contains(weekId)) {
        // Bu durumda hafta toplamƒ± G√ñSTERMƒ∞YORUZ
      } else if (needsWeekTotal) {
        // Hafta toplamƒ±nƒ± g√∂ster
        cells.add(Container(
          width: weeklyTotalWidth,
          padding: const EdgeInsets.all(4),
          decoration: BoxDecoration(
            color: weeklyTotalColor,
            border: Border.all(color: Colors.green.shade400, width: 1),
          ),
          alignment: Alignment.center,
          child: Text(
            'Hafta ${_getWeekOfYear(day)}',
            textAlign: TextAlign.center,
            style: const TextStyle(
              fontWeight: FontWeight.bold,
              fontSize: 12,
              color: Colors.black87,
            ),
          ),
        ));
      }
    }

    return cells;
  }

  // Fix 1: Better week calculation that respects calendar weeks
  int _getWeekOfMonth(DateTime date) {
    // Get first day of the month
    final firstDayOfMonth = DateTime(date.year, date.month, 1);
    // Get offset from Monday (1) to align with calendar weeks
    final weekOffset = (firstDayOfMonth.weekday - 1) % 7;
    // Calculate week number with offset
    return ((date.day + weekOffset - 1) ~/ 7) + 1;
  }

  // Aydaki hafta sayƒ±sƒ±nƒ± getir
  int _getWeeksInMonth() {
    // Ayƒ±n son g√ºn√º
    final lastDay = DateTime(DateTime.now().year, DateTime.now().month + 1, 0);
    // Ayƒ±n son g√ºn√ºn√ºn haftasƒ±
    return ((lastDay.day - 1) ~/ 7) + 1;
  }

  // Haftasonu kontrol√º
  bool _isWeekend(DateTime date) {
    return date.weekday == DateTime.saturday || date.weekday == DateTime.sunday;
  }

  // Dersin g√∂r√ºnen adƒ±nƒ± getir - G√ºncellendi
  String _getCourseDisplayName(EnumCourse course) {
    // Use the backend display values which include correct Turkish characters
    return _getBackendCourseString(course);
  }

  // Dersin rengini getir - G√ºncellendi
  Color _getCourseColor(EnumCourse course) {
    switch (course) {
      case EnumCourse.TURKCE:
        return Colors.red.shade50;
      case EnumCourse.MATEMATIK:
        return Colors.blue.shade50;
      case EnumCourse.FEN_BILIMLERI:
        return Colors.green.shade50;
      case EnumCourse.SOSYAL_BILGILER:
        return Colors.orange.shade50;
      case EnumCourse.INGILIZCE:
        return Colors.purple.shade50;
      case EnumCourse.DIKAB:
        return Colors.brown.shade50;
      default:
        return Colors.grey.shade50;
    }
  }

  // Frontend enum to backend string
  String _getBackendCourseString(EnumCourse course) {
    switch (course) {
      case EnumCourse.TURKCE:
        return 'T√úRK√áE';
      case EnumCourse.MATEMATIK:
        return 'MATEMATƒ∞K';
      case EnumCourse.FEN_BILIMLERI:
        return 'FEN Bƒ∞Lƒ∞MLERƒ∞';
      case EnumCourse.SOSYAL_BILGILER:
        return 'SOSYAL Bƒ∞LGƒ∞LER';
      case EnumCourse.INGILIZCE:
        return 'ƒ∞NGƒ∞Lƒ∞ZCE';
      case EnumCourse.DIKAB:
        return 'Dƒ∞KAB';
      default:
        throw Exception('Unknown course enum: $course');
    }
  }

  // ISO Hafta Hesaplamasƒ±
  int _getWeekOfYear(DateTime date) {
    // ISO hafta numarasƒ±nƒ± hesapla (yƒ±l i√ßindeki hafta)
    int dayOfYear = int.parse(DateFormat('D').format(date));
    int woy = ((dayOfYear - date.weekday + 10) / 7).floor();

    // Yƒ±lƒ±n ilk haftasƒ±ysa ve √∂nceki yƒ±lƒ±n son haftasƒ±na aitse kontrol et
    if (woy < 1) {
      // √ñnceki yƒ±lƒ±n son g√ºn√ºn√ºn hafta numarasƒ±nƒ± al
      DateTime prevYearLastDay = DateTime(date.year - 1, 12, 31);
      return _getWeekOfYear(prevYearLastDay);
    }
    // Yƒ±lƒ±n son haftasƒ±ysa ve sonraki yƒ±lƒ±n ilk haftasƒ±na aitse kontrol et
    else if (woy > 52) {
      // Yƒ±lƒ±n son g√ºn√º per≈üembe veya sonrasƒ± mƒ±?
      DateTime lastDay = DateTime(date.year, 12, 31);
      if (lastDay.weekday < 4) {
        return 1;
      }
    }
    return woy;
  }

  // ƒ∞ki tarihin aynƒ± haftada olup olmadƒ±ƒüƒ±nƒ± kontrol eder
  bool _isSameWeek(DateTime date1, DateTime date2) {
    // ƒ∞ki tarih aynƒ± ISO haftasƒ±nda mƒ±? (pazartesi-pazar arasƒ±)
    return _getWeekOfYear(date1) == _getWeekOfYear(date2) &&
        date1.year == date2.year;
  }

  // Haftalƒ±k toplam hesaplama metodlarƒ±
  int _calculateWeekTotalForStudent(int studentId, DateTime referenceDate, TrackingDataLoaded state) {
    return _getCachedWeekTotalForStudent(studentId, referenceDate, state);
  }

  int _calculateCourseWeekTotal(int studentId, DateTime referenceDate, EnumCourse course, TrackingDataLoaded state) {
    return _getCachedCourseWeekTotal(studentId, referenceDate, course, state);
  }

  // Test ve hata ayƒ±klama i√ßin hafta numaralarƒ±nƒ± g√∂r√ºnt√ºle
  void _debugWeekNumbers(List<DateTime> daysInMonth) {
    print('\nüîç Ay i√ßin hafta numaralarƒ±:');
    for (final day in daysInMonth) {
      final weekNum = _getWeekOfYear(day);
      print('üìÖ ${DateFormat('yyyy-MM-dd (E)').format(day)} - Hafta: $weekNum');
    }

    // Ay ge√ßi≈üleri i√ßin
    final prevMonthLastDay =
        DateTime(DateTime.now().year, DateTime.now().month, 0);
    final nextMonthFirstDay =
        DateTime(DateTime.now().year, DateTime.now().month + 1, 1);

    print('\nüîÑ Ay ge√ßi≈üleri:');
    print(
        '‚óÄÔ∏è √ñnceki ayƒ±n son g√ºn√º: ${DateFormat('yyyy-MM-dd (E)').format(prevMonthLastDay)} - Hafta: ${_getWeekOfYear(prevMonthLastDay)}');
    print(
        '‚ñ∂Ô∏è Sonraki ayƒ±n ilk g√ºn√º: ${DateFormat('yyyy-MM-dd (E)').format(nextMonthFirstDay)} - Hafta: ${_getWeekOfYear(nextMonthFirstDay)}');

    // Aynƒ± haftada mƒ± kontrol et
    if (_isSameWeek(prevMonthLastDay,
        DateTime(DateTime.now().year, DateTime.now().month, 1))) {
      print('üîÑ √ñnceki ayƒ±n son g√ºn√º ve bu ayƒ±n ilk g√ºn√º AYNI haftada!');
    }

    final lastDayOfCurrentMonth =
        DateTime(DateTime.now().year, DateTime.now().month + 1, 0);
    if (_isSameWeek(lastDayOfCurrentMonth, nextMonthFirstDay)) {
      print('üîÑ Bu ayƒ±n son g√ºn√º ve sonraki ayƒ±n ilk g√ºn√º AYNI haftada!');
    }
    print('\n');
  }

  // √ñƒürenci b√∂l√ºm√º i√ßin d√ºzeltilmi≈ü kod - Performance optimized
  Widget _buildStudentSection(Student student, TrackingDataLoaded state, List<DateTime> daysInMonth) {
    return BlocBuilder<DailyTrackingBloc, DailyTrackingState>(
      // Performance optimization: Only rebuild this student section when expansion state changes
      buildWhen: (previous, current) {
        if (current is! TrackingDataLoaded || previous is! TrackingDataLoaded) {
          return true;
        }
        
        // Only rebuild if this specific student's expansion state changed
        final currentExpanded = current.expandedStudents[student.id] ?? true;
        final previousExpanded = previous.expandedStudents[student.id] ?? true;
        
        return currentExpanded != previousExpanded ||
               current.trackingData != previous.trackingData ||
               current.selectedMonth != previous.selectedMonth;
      },
      builder: (context, state) {
        if (state is! TrackingDataLoaded) {
          return const SizedBox.shrink();
        }
        
        final isExpanded = state.expandedStudents[student.id] ?? true;

        // Sabit geni≈ülikler
        const double imageWidth = 200.0; // Daha k√º√ß√ºk resim geni≈üliƒüi

        // Ders listesi ve toplam satƒ±r i√ßin y√ºkseklik hesapla
        final int rowCount =
            EnumCourse.values.length + 1; // +1 for G√úNL√úK TOPLAM row
        final double rowHeight = 40.0; // Her satƒ±r i√ßin y√ºkseklik
        final double sectionHeight = rowCount * rowHeight; // Toplam y√ºkseklik

        // √ñƒürenci numarasƒ± mƒ± var?
        final hasStudentNumber = student.ogrenciNo?.isNotEmpty ?? false;

        return Card(
          margin: const EdgeInsets.symmetric(vertical: 2),
          child: Column(
            children: [
              // √ñƒürenci ba≈ülƒ±ƒüƒ± - tƒ±klanabilir
              InkWell(
                onTap: () {
                  context.read<DailyTrackingBloc>().add(ToggleStudentExpansion(student.id));
                },
                child: Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.blue.shade50,
                  ),
                  child: Row(
                    children: [
                      Expanded(
                        child: Text.rich(
                          TextSpan(
                            children: [
                              // √ñƒürenci numarasƒ± varsa, √∂nce numarayƒ± g√∂ster
                              if (hasStudentNumber)
                                TextSpan(
                                  text: '${student.ogrenciNo} - ',
                                  style: TextStyle(
                                    fontWeight: FontWeight.bold,
                                    fontSize: 16,
                                    color: Colors.blue.shade800,
                                  ),
                                ),
                              // Ardƒ±ndan √∂ƒürenci adƒ±nƒ± g√∂ster
                              TextSpan(
                                text: student.adSoyad,
                                style: const TextStyle(
                                  fontWeight: FontWeight.bold,
                                  fontSize: 16,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                      Icon(
                        isExpanded ? Icons.expand_less : Icons.expand_more,
                        color: Colors.blue.shade800,
                      ),
                    ],
                  ),
                ),
              ),

              // √ñƒürenci detaylarƒ± - geni≈ületilebilir
              if (isExpanded)
                Container(
                  // Sabit bir y√ºkseklik belirleme - t√ºm kartƒ±n boyutu sabit olacak
                  height: sectionHeight,
                  child: Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // √ñƒürenci resmi - daha k√º√ß√ºk ve sƒ±nƒ±rlandƒ±rƒ±lmƒ±≈ü
                      Container(
                        width: imageWidth,
                        height: sectionHeight,
                        padding: const EdgeInsets.all(16), // Daha fazla padding
                        child: ClipRRect(
                          borderRadius: BorderRadius.circular(8),
                          child: StudentImageWidget(
                            studentId: student.id,
                            width: imageWidth - 32, // padding i√ßin ayarla
                            height: sectionHeight - 32, // padding i√ßin ayarla
                            shape: StudentImageShape.rectangle,
                          ),
                        ),
                      ),

                      // Saƒü taraftaki diƒüer kodlar...
                      Expanded(
                        child: Column(
                          children: [
                            // G√úNL√úK TOPLAM satƒ±rƒ±
                            Container(
                              height: rowHeight,
                              color: Colors.blue.shade50,
                              child: Row(
                                children: [
                                  // G√úNL√úK TOPLAM etiketi
                                  Container(
                                    width: courseColWidth,
                                    height: rowHeight,
                                    padding: const EdgeInsets.all(8),
                                    alignment: Alignment.center,
                                    child: Container(
                                      decoration: BoxDecoration(
                                        color: Colors.blue.shade100,
                                        borderRadius: BorderRadius.circular(4),
                                      ),
                                      padding: const EdgeInsets.symmetric(
                                          horizontal: 8, vertical: 4),
                                      child: const Text(
                                        'G√úNL√úK TOPLAM',
                                        style: TextStyle(
                                            fontWeight: FontWeight.bold,
                                            fontSize: 12),
                                      ),
                                    ),
                                  ),

                                  // G√ºnl√ºk toplam deƒüerleri
                                  ..._buildDailyTotalCells(student, state),

                                  // Toplam s√ºtunu
                                  Container(
                                    width: totalColWidth,
                                    height: rowHeight,
                                    alignment: Alignment.center,
                                    child: Container(
                                      decoration: BoxDecoration(
                                        color: const Color.fromARGB(
                                            255, 248, 181, 251),
                                        borderRadius: BorderRadius.circular(4),
                                      ),
                                      padding: const EdgeInsets.symmetric(
                                          horizontal: 8, vertical: 4),
                                      child: Text(
                                        _calculateStudentMonthlyTotal(student.id, state)
                                            .toString(),
                                        style: const TextStyle(
                                            fontWeight: FontWeight.bold),
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),

                            // Ders satƒ±rlarƒ±
                            ...EnumCourse.values.map((course) => Container(
                                  height: rowHeight,
                                  child: Row(
                                    children: [
                                      // Ders adƒ±
                                      Container(
                                        width: courseColWidth,
                                        height: rowHeight,
                                        padding: const EdgeInsets.all(8),
                                        alignment: Alignment.center,
                                        child: Container(
                                          decoration: BoxDecoration(
                                            color: _getCourseColor(course),
                                            borderRadius: BorderRadius.circular(4),
                                            border: Border.all(
                                                color: Colors.grey.shade300),
                                          ),
                                          padding: const EdgeInsets.symmetric(
                                              horizontal: 8, vertical: 4),
                                          child: Text(
                                            _getCourseDisplayName(course),
                                            style: const TextStyle(
                                                fontWeight: FontWeight.bold,
                                                fontSize: 12),
                                          ),
                                        ),
                                      ),

                                      // Ders g√ºnl√ºk deƒüerleri
                                      ..._buildCourseDailyCells(student, course, state),

                                      // Ders toplam
                                      Container(
                                        width: totalColWidth,
                                        height: rowHeight,
                                        alignment: Alignment.center,
                                        child: Container(
                                          decoration: BoxDecoration(
                                            color: _getCourseColor(course),
                                            borderRadius: BorderRadius.circular(4),
                                          ),
                                          padding: const EdgeInsets.symmetric(
                                              horizontal: 8, vertical: 4),
                                          child: Text(
                                            _calculateCourseTotalForStudent(
                                                    student.id, course, state)
                                                .toString(),
                                            style: const TextStyle(
                                                fontWeight: FontWeight.bold),
                                          ),
                                        ),
                                      ),
                                    ],
                                  ),
                                )),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
            ],
          ),
        );
      },
    );
  }

  // Fix 5: Update daily total cells to use correct week calculation
  List<Widget> _buildDailyTotalCells(Student student, TrackingDataLoaded state) {
    List<Widget> cells = [];
    final daysInMonth = _getDaysInMonth(state.selectedMonth);

    // Hafta tanƒ±mlayƒ±cƒ±larƒ±nƒ± takip et
    Set<String> addedWeeks = {};

    // Yƒ±l-hafta formatƒ±nda benzersiz tanƒ±mlayƒ±cƒ±
    String weekIdentifier(DateTime date) =>
        '${date.year}-${_getWeekOfYear(date)}';

    for (int i = 0; i < daysInMonth.length; i++) {
      final day = daysInMonth[i];
      final isWeekend = _isWeekend(day);
      final dateStr = DateFormat('yyyy-MM-dd').format(day);

      // Bu g√ºn i√ßin toplam hesapla - Performance optimization: Cache this calculation
      final cacheKey = 'day_total_${student.id}_$dateStr';
      int dayTotal;
      if (_calculationCache.containsKey(cacheKey)) {
        dayTotal = _calculationCache[cacheKey]!;
      } else {
        dayTotal = 0;
        if (state.trackingData[student.id]?[dateStr] != null) {
          state.trackingData[student.id]![dateStr]!.forEach((course, count) {
            dayTotal += count;
          });
        }
        _calculationCache[cacheKey] = dayTotal;
      }

      // G√ºnl√ºk toplam h√ºcresi
      cells.add(Container(
        width: dayColWidth,
        height: 40,
        alignment: Alignment.center,
        decoration: BoxDecoration(
          color: isWeekend
              ? weekendBgColor
              : dayTotal > 0
                  ? dataEntryWeekdayColor
                  : weekdayBgColor,
          border: Border.all(color: Colors.grey.shade300, width: 0.5),
        ),
        child: Text(
          dayTotal.toString(),
          textAlign: TextAlign.center,
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: dayTotal > 0 ? Colors.black : Colors.grey.shade600,
          ),
        ),
      ));

      // Hafta toplamƒ± kontrol√º
      bool needsWeekTotal = false;
      String weekId = weekIdentifier(day);

      // Son g√ºne geldik mi?
      bool isLastDay = i == daysInMonth.length - 1;

      // Pazar g√ºn√º m√º?
      bool isWeekEnd = day.weekday == DateTime.sunday;

      // Yarƒ±n farklƒ± bir haftaya mƒ± ge√ßiyor?
      bool isNewWeekTomorrow = false;
      if (!isLastDay) {
        isNewWeekTomorrow = !_isSameWeek(day, daysInMonth[i + 1]);
      }

      // Hafta toplamƒ±nƒ± g√∂sterme kararƒ±
      if ((isWeekEnd ||
              (isLastDay && day.weekday == DateTime.sunday) ||
              isNewWeekTomorrow) &&
          !addedWeeks.contains(weekId)) {
        needsWeekTotal = true;
        addedWeeks.add(weekId);
      }

      // Ayƒ±n sonundayƒ±z ve hafta tamamlanmamƒ±≈ü - hafta toplamƒ± g√∂sterme
      if (isLastDay && !isWeekEnd && !addedWeeks.contains(weekId)) {
        // Bu durumda hafta toplamƒ± G√ñSTERMƒ∞YORUZ
      } else if (needsWeekTotal) {
        // Bu hafta i√ßin toplam hesapla - Performance optimization: Use cached version
        int weekTotal = _getCachedWeekTotalForStudent(student.id, day, state);

        cells.add(Container(
          width: weeklyTotalWidth,
          height: 40,
          alignment: Alignment.center,
          decoration: BoxDecoration(
            color: weeklyTotalColor,
            borderRadius: BorderRadius.circular(4),
            border: Border.all(color: Colors.green.shade400, width: 1),
          ),
          child: Text(
            weekTotal.toString(),
            textAlign: TextAlign.center,
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: weekTotal > 0 ? Colors.black : Colors.grey.shade700,
            ),
          ),
        ));
      }
    }
    return cells;
  }

  // Replace old calculation methods with cached versions
  int _calculateStudentMonthlyTotal(int studentId, TrackingDataLoaded state) {
    return _getCachedStudentMonthlyTotal(studentId, state);
  }

  int _calculateCourseTotalForStudent(int studentId, EnumCourse course, TrackingDataLoaded state) {
    return _getCachedCourseTotalForStudent(studentId, course, state);
  }

  // Performance optimization: Cached calculation methods
  int _getCachedStudentMonthlyTotal(int studentId, TrackingDataLoaded state) {
    final cacheKey = 'monthly_total_$studentId';
    if (_calculationCache.containsKey(cacheKey)) {
      return _calculationCache[cacheKey]!;
    }
    
    int total = 0;
    state.trackingData[studentId]?.forEach((date, courses) {
      courses.forEach((course, count) {
        total += count;
      });
    });
    
    _calculationCache[cacheKey] = total;
    return total;
  }

  int _getCachedCourseTotalForStudent(int studentId, EnumCourse course, TrackingDataLoaded state) {
    final cacheKey = 'course_total_${studentId}_${course.toString()}';
    if (_calculationCache.containsKey(cacheKey)) {
      return _calculationCache[cacheKey]!;
    }
    
    int total = 0;
    state.trackingData[studentId]?.forEach((date, courses) {
      total += courses[course] ?? 0;
    });
    
    _calculationCache[cacheKey] = total;
    return total;
  }

  int _getCachedWeekTotalForStudent(int studentId, DateTime referenceDate, TrackingDataLoaded state) {
    final int weekNum = _getWeekOfYear(referenceDate);
    final cacheKey = 'week_total_${studentId}_$weekNum';
    if (_calculationCache.containsKey(cacheKey)) {
      return _calculationCache[cacheKey]!;
    }
    
    int total = 0;
    if (state.weeklyData[studentId]?[weekNum] != null) {
      state.weeklyData[studentId]![weekNum]!.forEach((course, value) {
        total += value;
      });
    }
    
    _calculationCache[cacheKey] = total;
    return total;
  }

  int _getCachedCourseWeekTotal(int studentId, DateTime referenceDate, EnumCourse course, TrackingDataLoaded state) {
    final int weekNum = _getWeekOfYear(referenceDate);
    final cacheKey = 'course_week_total_${studentId}_${weekNum}_${course.toString()}';
    if (_calculationCache.containsKey(cacheKey)) {
      return _calculationCache[cacheKey]!;
    }
    
    final result = state.weeklyData[studentId]?[weekNum]?[course] ?? 0;
    _calculationCache[cacheKey] = result;
    return result;
  }

  // Optimized cell widget that shows Text by default, TextField when editing
  Widget _buildOptimizedDataCell({
    required int studentId,
    required DateTime date,
    required EnumCourse course,
    required int value,
    required bool isWeekend,
    required TrackingDataLoaded state,
  }) {
    final cellKey = '${studentId}_${DateFormat('yyyy-MM-dd').format(date)}_${course.toString()}';
    final isEditing = _editingCellKey == cellKey;
    
    return GestureDetector(
      onTap: () {
        setState(() {
          _editingCellKey = cellKey;
        });
      },
      child: Container(
        width: dayColWidth,
        height: 40,
        alignment: Alignment.center,
        decoration: BoxDecoration(
          color: isWeekend ? weekendBgColor : weekdayBgColor,
          border: Border.all(color: Colors.grey.shade300, width: 0.5),
        ),
        child: isEditing
            ? _buildEditableTextField(studentId, date, course, value, isWeekend)
            : _buildDisplayText(value, isWeekend),
      ),
    );
  }

  Widget _buildEditableTextField(int studentId, DateTime date, EnumCourse course, int value, bool isWeekend) {
    final controller = TextEditingController(text: value > 0 ? value.toString() : '');
    
    // Auto-focus when entering edit mode
    return TextField(
      controller: controller,
      autofocus: true,
      keyboardType: TextInputType.number,
      textAlign: TextAlign.center,
      style: TextStyle(
        fontSize: 14,
        color: isWeekend ? Colors.brown.shade800 : Colors.black,
        fontWeight: value > 0 ? FontWeight.bold : FontWeight.normal,
      ),
      decoration: InputDecoration(
        border: InputBorder.none,
        contentPadding: EdgeInsets.zero,
        filled: value > 0,
        fillColor: isWeekend ? dataEntryWeekendColor : dataEntryWeekdayColor,
      ),
      onSubmitted: (newValue) {
        _saveValue(studentId, date, course, newValue);
        setState(() {
          _editingCellKey = null;
        });
      },
      onTapOutside: (event) {
        _saveValue(studentId, date, course, controller.text);
        setState(() {
          _editingCellKey = null;
        });
      },
      onChanged: (newValue) {
        // Debounced saving
        final key = '${studentId}_${DateFormat('yyyy-MM-dd').format(date)}_${course.toString()}';
        _debounceTimers[key]?.cancel();
        _debounceTimers[key] = Timer(const Duration(milliseconds: 500), () {
          _saveValue(studentId, date, course, newValue);
          _debounceTimers.remove(key);
        });
      },
    );
  }

  Widget _buildDisplayText(int value, bool isWeekend) {
    return Container(
      width: double.infinity,
      height: double.infinity,
      alignment: Alignment.center,
      decoration: BoxDecoration(
        color: value > 0 
            ? (isWeekend ? dataEntryWeekendColor : dataEntryWeekdayColor)
            : Colors.transparent,
      ),
      child: Text(
        value > 0 ? value.toString() : '',
        textAlign: TextAlign.center,
        style: TextStyle(
          fontSize: 14,
          fontWeight: value > 0 ? FontWeight.bold : FontWeight.normal,
          color: value > 0 ? Colors.black : Colors.grey.shade600,
        ),
      ),
    );
  }

  void _saveValue(int studentId, DateTime date, EnumCourse course, String newValue) {
    final intValue = newValue.isEmpty ? 0 : int.tryParse(newValue) ?? 0;
    context.read<DailyTrackingBloc>().add(SaveTrackingData(
      studentId,
      date,
      course,
      intValue,
    ));
    // Clear cache for affected calculations
    _clearCalculationCache();
  }

  // Fix 6: Similar update for course cells to use correct week calculation
  List<Widget> _buildCourseDailyCells(Student student, EnumCourse course, TrackingDataLoaded state) {
    List<Widget> cells = [];
    final daysInMonth = _getDaysInMonth(state.selectedMonth);

    // Hafta tanƒ±mlayƒ±cƒ±larƒ±nƒ± takip et
    Set<String> addedWeeks = {};

    // Yƒ±l-hafta formatƒ±nda benzersiz tanƒ±mlayƒ±cƒ±
    String weekIdentifier(DateTime date) =>
        '${date.year}-${_getWeekOfYear(date)}';

    for (int i = 0; i < daysInMonth.length; i++) {
      final day = daysInMonth[i];
      final isWeekend = _isWeekend(day);
      final dateStr = DateFormat('yyyy-MM-dd').format(day);
      final value = state.trackingData[student.id]?[dateStr]?[course] ?? 0;

      // Performance optimization: Use optimized cell widget
      cells.add(_buildOptimizedDataCell(
        studentId: student.id,
        date: day,
        course: course,
        value: value,
        isWeekend: isWeekend,
        state: state,
      ));

      // Hafta toplamƒ± kontrol√º
      bool needsWeekTotal = false;
      String weekId = weekIdentifier(day);

      // Son g√ºne geldik mi?
      bool isLastDay = i == daysInMonth.length - 1;

      // Pazar g√ºn√º m√º?
      bool isWeekEnd = day.weekday == DateTime.sunday;

      // Yarƒ±n farklƒ± bir haftaya mƒ± ge√ßiyor?
      bool isNewWeekTomorrow = false;
      if (!isLastDay) {
        isNewWeekTomorrow = !_isSameWeek(day, daysInMonth[i + 1]);
      }

      // Hafta toplamƒ±nƒ± g√∂sterme kararƒ±
      if ((isWeekEnd ||
              (isLastDay && day.weekday == DateTime.sunday) ||
              isNewWeekTomorrow) &&
          !addedWeeks.contains(weekId)) {
        needsWeekTotal = true;
        addedWeeks.add(weekId);
      }

      // Ayƒ±n sonundayƒ±z ve hafta tamamlanmamƒ±≈ü - hafta toplamƒ± g√∂sterme
      if (isLastDay && !isWeekEnd && !addedWeeks.contains(weekId)) {
        // Bu durumda hafta toplamƒ± G√ñSTERMƒ∞YORUZ
      } else if (needsWeekTotal) {
        // Bu hafta ve kurs i√ßin toplam hesapla - Performance optimization: Use cached version
        int weekValue = _getCachedCourseWeekTotal(student.id, day, course, state);

        cells.add(Container(
          width: weeklyTotalWidth,
          height: 40,
          alignment: Alignment.center,
          decoration: BoxDecoration(
            color: weekValue > 0
                ? _getCourseColor(course).withOpacity(0.7)
                : _getCourseColor(course).withOpacity(0.3),
            borderRadius: BorderRadius.circular(4),
            border: Border.all(color: weeklyTotalColor, width: 1),
          ),
          child: Text(
            weekValue.toString(),
            textAlign: TextAlign.center,
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: weekValue > 0 ? Colors.black : Colors.grey.shade700,
            ),
          ),
        ));
      }
    }

    return cells;
  }
} 